<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OrigAuthToken NFT 조회</title>

    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <!-- Web3.js -->
    <script src="https://cdn.jsdelivr.net/npm/web3@latest/dist/web3.min.js"></script>

    <!-- Axios -->
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

    <!-- Bootstrap CSS -->
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Bootstrap JS and Popper.js (for Bootstrap functionality) -->
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script>
</head>
<body>
    <div class="container">
        <h1>OrigAuthToken NFT 조회</h1>

        <!-- 사용자 주소 입력 및 조회 버튼 -->
        <div class="form-group">
            <label for="walletAddress">지갑 주소 입력:</label>
            <input type="text" id="walletAddress" class="form-control" placeholder="지갑 주소를 입력하세요">
        </div>
        <button id="checkNFTBtn" class="btn btn-primary">NFT 확인</button>
        
        <!-- NFT ID 및 URI 배열을 표시할 영역 -->
        <h3>결과</h3>
        <div id="nftStatus"></div>

        <a href="../index.html">홈으로 돌아가기</a>
    </div>

    <script>
        const contractAddress = "0x53f40fD4E98d3e70c14dcc4e3D00e2c59B9b567A"; // 스마트 컨트랙트 주소
        let abi = null;

        // 이더리움 주소 유효성 검사 함수
        function isValidEthereumAddress(address) {
            return /^0x[a-fA-F0-9]{40}$/.test(address);
        }

        // ABI를 JSON 파일에서 로드하는 함수
        async function loadABI() {
            try {
                const response = await fetch('../js/OrigAuthToken.json'); // ABI JSON 파일 경로
                const data = await response.json();
                abi = data.abi; // ABI 값을 저장
                console.log('ABI Loaded:', abi);
            } catch (error) {
                console.error('ABI 로드 중 오류 발생:', error);
            }
        }

        // Web3 인스턴스를 블록체인 노드에 연결
        const web3 = new Web3(new Web3.providers.HttpProvider("https://61.32.68.66:80")); // 포트 번호는 환경에 맞게 수정

        // NFT ID 및 URI 배열을 확인하는 함수
        async function checkNFT(userAddress) {
            const nftStatusDiv = document.getElementById("nftStatus");

            try {
                // 스마트 컨트랙트 인스턴스 생성
                const nftContract = new web3.eth.Contract(abi, contractAddress);

                // 사용자의 NFT ID와 URI 조회
                const result = await nftContract.methods.getMyNFTs().call({ from: userAddress });

                const tokenIds = result[0];
                const tokenURIs = result[1];

                if (tokenIds.length > 0) {
                    // NFT ID와 URI 배열을 출력
                    nftStatusDiv.innerHTML = `
                        <strong>이 주소가 보유한 NFT ID 목록:</strong> [${tokenIds.join(', ')}] <br>
                        <strong>이 주소가 보유한 NFT URI 목록:</strong> [${tokenURIs.join(', ')}]
                    `;
                } else {
                    nftStatusDiv.innerHTML = '이 주소는 NFT를 보유하고 있지 않습니다.';
                }
            } catch (error) {
                console.error("NFT 확인 중 오류 발생:", error);
                nftStatusDiv.innerHTML = 'NFT 확인 중 오류가 발생했습니다.';
            }
        }

        // 조회 버튼 클릭 이벤트 리스너
        document.getElementById("checkNFTBtn").addEventListener("click", async function() {
            const userAddress = document.getElementById("walletAddress").value.trim();

            // 지갑 주소 유효성 검사 후 NFT 여부 확인
            if (isValidEthereumAddress(userAddress)) {
                document.getElementById("nftStatus").innerHTML = `
                    <div class="spinner-border text-primary" role="status">
                        <span class="sr-only">Loading...</span>
                    </div>
                `;

                // ABI 로드 후 NFT 확인
                if (!abi) {
                    await loadABI(); // ABI가 로드되지 않았다면 먼저 로드
                }

                if (abi) {
                    checkNFT(userAddress);
                }
            } else {
                alert("유효하지 않은 지갑 주소입니다. 다시 확인해 주세요.");
            }
        });

        // 페이지 로드 시 ABI 로드
        loadABI();
    </script>
</body>
</html>
