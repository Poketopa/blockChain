<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OrigAuthToken NFT 조회</title>

    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <!-- Web3.js -->
    <script src="https://cdn.jsdelivr.net/npm/web3@latest/dist/web3.min.js"></script>

    <!-- Axios -->
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

    <!-- Bootstrap CSS -->
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Bootstrap JS and Popper.js (for Bootstrap functionality) -->
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script>
</head>
<body>
    <div class="container">
        <h1>OrigAuthToken NFT 조회</h1>
	<div class="text-right mb-3">
	    <button id="userModeBtn" class="btn btn-success">사용자 모드</button>
	    <button id="devModeBtn" class="btn btn-primary">개발자 모드</button>
	</div>

        <!-- 사용자 주소 입력 및 조회 버튼 -->
	<div id="devMode" style="display: none;">
	        <div class="form-group">
	            <label for="walletAddress">지갑 주소 입력:</label>
	            <input type="text" id="walletAddress" class="form-control" placeholder="지갑 주소를 입력하세요">
	        </div>
	        <button id="checkWalletBtn" class="btn btn-primary">지갑 확인</button>
	        
	        <!-- 홈으로 돌아가기 버튼 -->
	        <div class="my-4 text-right">
	            <a href="../index.html" class="btn btn-secondary">홈으로 돌아가기</a>
		    <button id="checkLocalStorageBtn" class="btn btn-info ml-2">로컬 스토리지 확인하기</button>
	        </div>
	
	        <!-- 수직 구분선 -->
	        <hr class="my-4">
	
	        <!-- NFT 이미지가 표시될 영역 -->
	        <div id="nftGallery" class="row"></div>
	    </div>
        </div>

	<div id="userMode" style="display: none;">
	    <div id="userMessage" class="alert alert-warning" role="alert" style="display: none;">
	        카카오 로그인을 해주세요
	    </div>
	
	    <!-- NFT 이미지가 표시될 영역 -->
	    <div id="nftGalleryUser" class="row"></div>
	</div>
	

    <script>
// 모드 전환 버튼 클릭 이벤트
	document.getElementById("userModeBtn").addEventListener("click", function() {
	    // 사용자 모드로 전환
	    document.getElementById("devMode").style.display = "none";
	    document.getElementById("userMode").style.display = "block";
	    const storedWalletAddress = localStorage.getItem("walletAddress");
	
	    if (storedWalletAddress && isValidEthereumAddress(storedWalletAddress)) {
	        if (!abi) loadABI().then(() => checkWallet(storedWalletAddress, true));
	        else checkWallet(storedWalletAddress, true);
	    } else {
	        document.getElementById("userMessage").style.display = "block";
	    }
	});

	document.getElementById("devModeBtn").addEventListener("click", function() {
	    // 개발자 모드로 전환
	    document.getElementById("devMode").style.display = "block";
	    document.getElementById("userMode").style.display = "none";
	});


        const contractAddress = "0x53f40fD4E98d3e70c14dcc4e3D00e2c59B9b567A"; // 스마트 컨트랙트 주소
        let abi = null;
        let tokenIds = [];
        let tokenURIs = [];
        const pinataBaseUrl = "https://chocolate-elegant-cougar-341.mypinata.cloud/ipfs/";

        // 이더리움 주소 유효성 검사 함수
        function isValidEthereumAddress(address) {
            return /^0x[a-fA-F0-9]{40}$/.test(address);
        }

        // ABI를 JSON 파일에서 로드하는 함수
        async function loadABI() {
            try {
                const response = await fetch('../js/OrigAuthToken.json'); // ABI JSON 파일 경로
                const data = await response.json();
                abi = data.abi; // ABI 값을 저장
                console.log('ABI Loaded:', abi);
            } catch (error) {
                console.error('ABI 로드 중 오류 발생:', error);
            }
        }

        // Web3 인스턴스를 블록체인 노드에 연결
        //const web3 = new Web3(new Web3.providers.HttpProvider("http://192.168.10.39:80")); // 포트 번호는 환경에 맞게 수정
        const web3 = new Web3(new Web3.providers.HttpProvider("http://61.32.68.66:80")); // 포트 번호는 환경에 맞게 수정

        // 지갑을 확인하고 NFT 목록을 가져오는 함수
        async function checkWallet(userAddress) {
            const nftGalleryDiv = document.getElementById("nftGallery");
            nftGalleryDiv.innerHTML = ''; // 기존 내용 초기화

            try {
                // 스마트 컨트랙트 인스턴스 생성
                const nftContract = new web3.eth.Contract(abi, contractAddress);

                // 사용자의 NFT ID와 URI 조회
                const result = await nftContract.methods.getMyNFTs().call({ from: userAddress });

                tokenIds = result[0];
                tokenURIs = result[1];

                if (tokenIds.length > 0) {
                    // 각 NFT의 이미지를 가져와 가로 3개씩 출력
                    for (let i = 0; i < tokenIds.length; i++) {
                        const selectedTokenURI = tokenURIs[i];
                        const finalUrl = pinataBaseUrl + selectedTokenURI;

                        // NFT 메타데이터에서 이미지 URL 가져오기
                        const response = await axios.get(finalUrl);
                        const nftData = response.data;
                        const imageUrl = pinataBaseUrl + nftData.image.replace("ipfs://", "");

                        // 이미지 HTML을 가로 3개씩 배치 (Bootstrap 컬럼 사용)
                        nftGalleryDiv.innerHTML += `
                            <div class="col-md-4">
                                <img src="${imageUrl}" alt="${nftData.name}" class="img-fluid mt-3" style="max-width: 100%; height: auto;">
                            </div>
                        `;
                    }
                } else {
                    nftGalleryDiv.innerHTML = '이 주소는 NFT를 보유하고 있지 않습니다.';
                }
            } catch (error) {
                console.error("지갑 확인 중 오류 발생:", error);
                nftGalleryDiv.innerHTML = '지갑 확인 중 오류가 발생했습니다.';
            }
        }

        // 지갑 확인 버튼 클릭 이벤트 리스너
        document.getElementById("checkWalletBtn").addEventListener("click", async function() {
            const userAddress = document.getElementById("walletAddress").value.trim();

            // 지갑 주소 유효성 검사 후 NFT 여부 확인
            if (isValidEthereumAddress(userAddress)) {
                document.getElementById("nftGallery").innerHTML = `
                    <div class="spinner-border text-primary" role="status">
                        <span class="sr-only">Loading...</span>
                    </div>
                `;

                // ABI 로드 후 지갑 확인
                if (!abi) {
                    await loadABI(); // ABI가 로드되지 않았다면 먼저 로드
                }

                if (abi) {
                    checkWallet(userAddress);
                }
            } else {
                alert("유효하지 않은 지갑 주소입니다. 다시 확인해 주세요.");
            }
        });

	// 페이지 로드 시 로컬 스토리지 값 자동 입력 및 지갑 확인
	window.onload = async function() {
		const storedWalletAddress = localStorage.getItem("walletAddress");

		if (storedWalletAddress) {
			// 지갑 주소 입력 필드에 로컬 스토리지 값 자동 입력
			document.getElementById("walletAddress").value = storedWalletAddress;

			// 자동으로 지갑 확인 수행
			if (isValidEthereumAddress(storedWalletAddress)) {
	   			document.getElementById("nftGallery").innerHTML = `
	   				<div class="spinner-border text-primary" role="status">
	   					<span class="sr-only">Loading...</span>
	   				</div>
				`;

	                	// ABI 로드 후 자동으로 지갑 확인
				if (!abi) {
					await loadABI();
				}
				if (abi) {
					checkWallet(storedWalletAddress);
				}
			}
		}
	};


	    // 로컬 스토리지 확인 버튼 클릭 이벤트 리스너
	    document.getElementById("checkLocalStorageBtn").addEventListener("click", function() {
			    const walletAddress = localStorage.getItem("walletAddress");
			    const privateKey = localStorage.getItem("privateKey");

		// 팝업창으로 로컬 스토리지에 저장된 값 보여주기
		alert(`Wallet Address: ${walletAddress}\nPrivate Key: ${privateKey}`);
	});
	

        // 페이지 로드 시 ABI 로드
        loadABI();
    </script>
</body>
</html>
