
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard</title>

    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <!-- Web3.js -->
    <script src="https://cdn.jsdelivr.net/npm/web3@latest/dist/web3.min.js"></script>

    <!-- Axios -->
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

    <!-- Bootstrap CSS -->
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Bootstrap JS and Popper.js (for Bootstrap functionality) -->
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script>
</head>
<body>
    <div class="container">
        <h1>Dashboard</h1>
        <p>Welcome to your dashboard!</p>
        
        <!-- 사용자 주소 입력 및 조회 버튼 -->
        <div class="form-group">
            <label for="walletAddress">Enter Wallet Address:</label>
            <input type="text" id="walletAddress" class="form-control" placeholder="Enter wallet address here">
        </div>
        <button id="fetchNFTsBtn" class="btn btn-primary">조회</button>
        
        <!-- NFT 목록을 표시할 영역 -->
        <h3>Your NFT List</h3>
        <div id="nftList"></div>

        <a href="../index.html">Back to Home</a>
    </div>

    <script>
        const contractAddress = "0xA8A9C8A26A803825BF40D1810f81A7763b0988E8"; // Contract address는 필요

        const abi = [
                    {
                        "inputs": [],
                        "stateMutability": "nonpayable",
                        "type": "constructor"
                    },
                    {
                        "anonymous": false,
                        "inputs": [
                            {
                                "indexed": true,
                                "internalType": "address",
                                "name": "owner",
                                "type": "address"
                            },
                            {
                                "indexed": true,
                                "internalType": "address",
                                "name": "approved",
                                "type": "address"
                            },
                            {
                                "indexed": true,
                                "internalType": "uint256",
                                "name": "tokenId",
                                "type": "uint256"
                            }
                        ],
                        "name": "Approval",
                        "type": "event"
                    },
                    {
                        "anonymous": false,
                        "inputs": [
                            {
                                "indexed": true,
                                "internalType": "address",
                                "name": "owner",
                                "type": "address"
                            },
                            {
                                "indexed": true,
                                "internalType": "address",
                                "name": "operator",
                                "type": "address"
                            },
                            {
                                "indexed": false,
                                "internalType": "bool",
                                "name": "approved",
                                "type": "bool"
                            }
                        ],
                        "name": "ApprovalForAll",
                        "type": "event"
                    },
                    {
                        "anonymous": false,
                        "inputs": [
                            {
                                "indexed": true,
                                "internalType": "address",
                                "name": "from",
                                "type": "address"
                            },
                            {
                                "indexed": true,
                                "internalType": "address",
                                "name": "to",
                                "type": "address"
                            },
                            {
                                "indexed": true,
                                "internalType": "uint256",
                                "name": "tokenId",
                                "type": "uint256"
                            }
                        ],
                        "name": "Transfer",
                        "type": "event"
                    },
                    {
                        "inputs": [
                            {
                                "internalType": "address",
                                "name": "to",
                                "type": "address"
                            },
                            {
                                "internalType": "uint256",
                                "name": "tokenId",
                                "type": "uint256"
                            }
                        ],
                        "name": "approve",
                        "outputs": [],
                        "stateMutability": "nonpayable",
                        "type": "function"
                    },
                    {
                        "inputs": [
                            {
                                "internalType": "address",
                                "name": "owner",
                                "type": "address"
                            }
                        ],
                        "name": "balanceOf",
                        "outputs": [
                            {
                                "internalType": "uint256",
                                "name": "",
                                "type": "uint256"
                            }
                        ],
                        "stateMutability": "view",
                        "type": "function"
                    },
                    {
                        "inputs": [
                            {
                                "internalType": "uint256",
                                "name": "tokenId",
                                "type": "uint256"
                            }
                        ],
                        "name": "getApproved",
                        "outputs": [
                            {
                                "internalType": "address",
                                "name": "",
                                "type": "address"
                            }
                        ],
                        "stateMutability": "view",
                        "type": "function"
                    },
                    {
                        "inputs": [
                            {
                                "internalType": "address",
                                "name": "owner",
                                "type": "address"
                            },
                            {
                                "internalType": "address",
                                "name": "operator",
                                "type": "address"
                            }
                        ],
                        "name": "isApprovedForAll",
                        "outputs": [
                            {
                                "internalType": "bool",
                                "name": "",
                                "type": "bool"
                            }
                        ],
                        "stateMutability": "view",
                        "type": "function"
                    },
                    {
                        "inputs": [],
                        "name": "name",
                        "outputs": [
                            {
                                "internalType": "string",
                                "name": "",
                                "type": "string"
                            }
                        ],
                        "stateMutability": "view",
                        "type": "function"
                    },
                    {
                        "inputs": [
                            {
                                "internalType": "uint256",
                                "name": "tokenId",
                                "type": "uint256"
                            }
                        ],
                        "name": "ownerOf",
                        "outputs": [
                            {
                                "internalType": "address",
                                "name": "",
                                "type": "address"
                            }
                        ],
                        "stateMutability": "view",
                        "type": "function"
                    },
                    {
                        "inputs": [
                            {
                                "internalType": "address",
                                "name": "from",
                                "type": "address"
                            },
                            {
                                "internalType": "address",
                                "name": "to",
                                "type": "address"
                            },
                            {
                                "internalType": "uint256",
                                "name": "tokenId",
                                "type": "uint256"
                            }
                        ],
                        "name": "safeTransferFrom",
                        "outputs": [],
                        "stateMutability": "nonpayable",
                        "type": "function"
                    },
                    {
                        "inputs": [
                            {
                                "internalType": "address",
                                "name": "from",
                                "type": "address"
                            },
                            {
                                "internalType": "address",
                                "name": "to",
                                "type": "address"
                            },
                            {
                                "internalType": "uint256",
                                "name": "tokenId",
                                "type": "uint256"
                            },
                            {
                                "internalType": "bytes",
                                "name": "data",
                                "type": "bytes"
                            }
                        ],
                        "name": "safeTransferFrom",
                        "outputs": [],
                        "stateMutability": "nonpayable",
                        "type": "function"
                    },
                    {
                        "inputs": [
                            {
                                "internalType": "address",
                                "name": "operator",
                                "type": "address"
                            },
                            {
                                "internalType": "bool",
                                "name": "approved",
                                "type": "bool"
                            }
                        ],
                        "name": "setApprovalForAll",
                        "outputs": [],
                        "stateMutability": "nonpayable",
                        "type": "function"
                    },
                    {
                        "inputs": [
                            {
                                "internalType": "uint256",
                                "name": "tokenId",
                                "type": "uint256"
                            }
                        ],
                        "name": "tokenURI",
                        "outputs": [
                            {
                                "internalType": "string",
                                "name": "",
                                "type": "string"
                            }
                        ],
                        "stateMutability": "view",
                        "type": "function"
                    },
                    {
                        "inputs": [
                            {
                                "internalType": "string",
                                "name": "userId",
                                "type": "string"
                            }
                        ],
                        "name": "isExist",
                        "outputs": [
                            {
                                "internalType": "bool",
                                "name": "",
                                "type": "bool"
                            }
                        ],
                        "stateMutability": "view",
                        "type": "function"
                    },
                    {
                        "inputs": [
                            {
                                "internalType": "string",
                                "name": "userId",
                                "type": "string"
                            },
                            {
                                "internalType": "address",
                                "name": "_publickey",
                                "type": "address"
                            },
                            {
                                "internalType": "bytes32",
                                "name": "_privatekey",
                                "type": "bytes32"
                            }
                        ],
                        "name": "createAccount",
                        "outputs": [],
                        "stateMutability": "nonpayable",
                        "type": "function"
                    },
                    {
                        "inputs": [
                            {
                                "internalType": "string",
                                "name": "userId",
                                "type": "string"
                            }
                        ],
                        "name": "getAccount",
                        "outputs": [
                            {
                                "components": [
                                    {
                                        "internalType": "address",
                                        "name": "publickey",
                                        "type": "address"
                                    },
                                    {
                                        "internalType": "bytes32",
                                        "name": "privatekey",
                                        "type": "bytes32"
                                    }
                                ],
                                "internalType": "struct OrigAuthToken.Account",
                                "name": "",
                                "type": "tuple"
                            }
                        ],
                        "stateMutability": "view",
                        "type": "function"
                    }
                    ];

        // 이더리움 주소 유효성 검사 함수
        function isValidEthereumAddress(address) {
            return /^0x[a-fA-F0-9]{40}$/.test(address);
        }

        // NFT 목록을 조회하는 함수
        async function loadNFTs(userAddress) {
            // Web3 인스턴스를 블록체인 노드에 연결
            const web3 = new Web3(new Web3.providers.HttpProvider("http://61.32.68.66:80")); // 포트 번호 확인 필요

            try {
                // 스마트 컨트랙트 인스턴스 생성
                const nftContract = new web3.eth.Contract(abi, contractAddress); // ABI는 별도로 포함해야 함
                console.log("Connected to contract:", nftContract);

                // 사용자의 NFT 보유 수량 조회
                const balance = await nftContract.methods.balanceOf(userAddress).call();
                console.log("NFT balance for address", userAddress, ":", balance);

                const nftListDiv = document.getElementById("nftList");

                if (balance > 0) {
                    nftListDiv.innerHTML = ''; // 기존 내용을 초기화

                    // 병렬로 모든 토큰 ID와 URI 요청을 처리
                    const tokenIds = await Promise.all(
                        [...Array(balance).keys()].map(i => nftContract.methods.tokenOfOwnerByIndex(userAddress, i).call())
                    );
                    console.log("Token IDs:", tokenIds);

                    const tokenURIs = await Promise.all(
                        tokenIds.map(tokenId => nftContract.methods.tokenURI(tokenId).call())
                    );
                    console.log("Token URIs:", tokenURIs);

                    // NFT 목록을 화면에 표시
                    for (let i = 0; i < balance; i++) {
                        const response = await fetch(tokenURIs[i]);
                        const metadata = await response.json();
                        console.log("Metadata for token", tokenIds[i], ":", metadata);

                        const nftElement = document.createElement("div");
                        nftElement.className = "nft-item";
                        nftElement.innerHTML = `
                            <strong>Token ID:</strong> ${tokenIds[i]} <br>
                            <strong>Name:</strong> ${metadata.name} <br>
                            <img src="${metadata.image}" alt="${metadata.name}" style="max-width: 200px;">
                        `;
                        nftListDiv.appendChild(nftElement);
                    }
                } else {
                    nftListDiv.innerHTML = '소유한 NFT가 없습니다.';
                }
            } catch (error) {
                console.error("Error fetching NFTs:", error);
                document.getElementById("nftList").innerHTML = `
                    NFT를 가져오는 중 오류가 발생했습니다. <br>
                    <button id="retryBtn" class="btn btn-danger">재시도</button>
                `;
                document.getElementById("retryBtn").addEventListener("click", () => loadNFTs(userAddress));
            }
        }

        // 조회 버튼 클릭 이벤트 리스너
        document.getElementById("fetchNFTsBtn").addEventListener("click", function() {
            const userAddress = document.getElementById("walletAddress").value.trim();

            // 지갑 주소 유효성 검사 후 NFT 목록 조회
            if (isValidEthereumAddress(userAddress)) {
                document.getElementById("nftList").innerHTML = `
                    <div class="spinner-border text-primary" role="status">
                        <span class="sr-only">Loading...</span>
                    </div>
                `;
                loadNFTs(userAddress);
            } else {
                alert("유효하지 않은 지갑 주소입니다. 다시 확인해 주세요.");
            }
        });
    </script>
</body>
</html>

